<?php 
require 'includes/PHPMailer.php';
require 'includes/SMTP.php';
require 'includes/Exception.php';

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\SMTP;
use PHPMailer\PHPMailer\Exception;

include('includes/dbconnection.php');
session_start();
error_reporting(0);

require __DIR__ . '/vendor/autoload.php';

use Twilio\Rest\Client;

$sid    = "AC2951d1d8e5b727800ac2e88a04319202";
$token  = "4dff9b13216012fbfa94c5e22f266b0f";
$twilio = new Client($sid, $token);
if(isset($_POST['submit']))
  {
    $query4=mysqli_query($con,"select * from tblpage where PageType='contactus'");
              while($row4=mysqli_fetch_array($query4))
              {
                $salonemail = $row4['Email'];
                $salonaddr = $row4['PageDescription'];
                $salonaddr2 = str_replace('<br>', '', $salonaddr) ;
              }

        $query3=mysqli_query($con,"select * from tblsms");
              while($row3=mysqli_fetch_array($query3))
              {
                $phonesalon = $row3['PhoneNumber'];
                $phonesalon2 = substr($phonesalon, 0, 2).'-'.substr($phonesalon, 2, 3).'-'.substr($phonesalon, 5, 3).'-'.substr($phonesalon, 8,4);
              }

    $name=$_POST['name'];
    $fname = explode(' ',trim($name));
    $email=$_POST['email'];
    $services=$_POST['serv'];
    $serviceslower=strtolower($_POST['serv']);
    $adate=$_POST['date'];
    $atime=$_POST['time'];
    $phone="+1".str_replace("-", "", $_POST['phone']);
    $aptnumber = mt_rand(100000000, 999999999);
    $employee=$_POST['emp'];
    $notes = $_POST['notes'];
    $query=mysqli_query($con,"insert into tblappointment(AptNumber,Name,Email,PhoneNumber,EmployeeName,AptDate,AptTime,Services,Notes) value('$aptnumber','$name','$email','$phone','$employee','$adate','$atime','$services','$notes')");
    if ($query) {
 
try
 {
  //SMS Notification to Salon
  $message = $twilio->messages
                  ->create($phonesalon, 
                           array(
                               "body" => "You have a new online booking appointment. Here are the details: ". "\n" ."Name: ".$name. "\n" ."Appointment No.: ".$aptnumber. "\n" ."Service: ".$services. "\n" ."Date/Time: ".$adate." ".$atime. "\n" ."Technician: ".$employee."",
                               "from" => "+12054635799"
                           )
                  );


   //SMS Notification to Patric
  $message = $twilio->messages
                  ->create("+17144488888", 
                           array(
                               "body" => "You have a new online booking appointment. Here are the details: ". "\n" ."Name: ".$name. "\n" ."Appointment No.: ".$aptnumber. "\n" ."Service: ".$services. "\n" ."Date/Time: ".$adate." ".$atime. "\n" ."Technician: ".$employee."",
                               "from" => "+12054635799"
                           )
                  );
  }
   catch (\Exception $e)
 {

 }

try
 {
//SMS Notification to Customer
                    $message = $twilio->messages
                  ->create($phone, 
                           array(
                               "body" => "Hi ".$fname[0]."! This is a reminder that you have a ".$serviceslower." appointment with ".$employee." at My Pedi Spa this ".$adate." at ".$atime.". Please call us at ".$phonesalon2." if you need to reschedule! Our location is at ".$salonaddr2.". Your appointment number is ".$aptnumber. ".",
                               "from" => "+12054635799"
                           )
                  );


                  //SMS Notification to Patrick
                    $message = $twilio->messages
                  ->create("+17144488888",
                           array(
                               "body" => "Hi ".$fname[0]."! This is a reminder that you have a ".$serviceslower." appointment with ".$employee." at My Pedi Spa this ".$adate." at ".$atime.". Please call us at ".$phonesalon2." if you need to reschedule! Our location is at ".$salonaddr2.". Your appointment number is ".$aptnumber. ".",
                               "from" => "+12054635799"
                           )
                  );

 }
   catch (\Exception $e)
 {

 }

//EMAIL Notification to Customer
$subject = 'My Pedi Spa Online Appointment';


 
$msg = '<table style="height: 290px; width: 592px;
            font-family: Arial; color:#3a3d3c;">
<tbody>
<tr>
<td style="width: 386px; padding: 3%;">
<h1>Thank You</h1>
<p>Hi '.$fname[0].',</p>
<p>Your appointment has been booked with My Pedi Spa.</p>
<p><strong>When:</strong> '.$adate.', '.$atime.'<br /><strong>Service:</strong> '.$services.'<br /><strong>Technician:</strong> '.$employee.'<br /><strong>Appointment Number:</strong> '.$aptnumber.'</p>
<p>Best Regards,<br />My Pedi Spa</p>
<p>&nbsp;</p>
</td>
<td style="width: 190px; background-color: #efefef; padding: 3%; border-radius: 10px;">
<img src="https://mypedispa.com/assets/img/icons/logo.png" style="width:150px;height: 50px;">
<p><h3>My Pedi Spa</h3><br /> <a href="https://www.google.com/maps/place/'.$salonaddr2.'" target="_blank">'.$salonaddr.'</a><br /> <a href="tel:'.$phonesalon.'">'.$phonesalon2.'</a><br><a href="mailto:'.$salonemail.'">'.$salonemail.'</a></p>
<p><br /><a title="Visit Website" href="https://mypedispa.com/" target="_blank" rel="noopener">Visit Website</a></p>
</td>
</tr>
</tbody>
</table>';

       $mail = new PHPMailer();
    $mail->isSMTP();                                            // Send using SMTP
    $mail->Host       = 'az1-ss30.a2hosting.com';                    // Set the SMTP server to send through
    $mail->SMTPAuth   = true;                                   // Enable SMTP authentication
    $mail->Username   = 'no-reply@mypedispa.com';                     // SMTP username
    $mail->Password   = '{IzezL%*m)!N';                               // SMTP password
    $mail->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
    $mail->Port = "587";                                    // TCP port to connect to, use 465 for `PHPMailer::ENCRYPTION_SMTPS` above

    //Recipients
  $mail->setFrom('no-reply@mypedispa.com', 'no-reply@mypedispa.com');  //from
$mail->addAddress($email, $name);     // to
   
$mail->addReplyTo($salonemail, 'My Pedi Spa');



    // Content
    $mail->isHTML(true);                                  // Set email format to HTML
    $mail->Subject = $subject;
    $mail->Body    = $msg;
   

  $mail->send();

//EMAIL Notification to Salon
$subject2 = 'Notification: NEW My Pedi Spa Online Appointment';

$msg2= '<table style="height: 290px; width: 592px;
            font-family: Arial; color:#3a3d3c;">
<tbody>
<tr>
<td style="width: 386px; padding: 3%;">
<h1>You have a new online booking appointment</h1>
<p>Here are the details:</p>
<p><strong>When:</strong> '.$adate.', '.$atime.'<br /><strong>Service:</strong> '.$services.'<br /><strong>Technician:</strong> '.$employee.'<br /><strong>Appointment Number:</strong> '.$aptnumber.'</p>
<p>&nbsp;</p>
</td>
<td style="width: 190px; background-color: #efefef; padding: 3%; border-radius: 10px;">
<img src="https://mypedispa.com/assets/img/icons/logo.png" style="width:150px;height: 50px;">
<p><h3>My Pedi Spa</h3><br /> <a href="https://www.google.com/maps/place/'.$salonaddr2.'" target="_blank">'.$salonaddr.'</a><br /> <a href="tel:'.$phonesalon.'">'.$phonesalon2.'</a><br><a href="mailto:'.$salonemail.'">'.$salonemail.'</a></p>
<p><br /><a title="Visit Website" href="https://mypedispa.com/" target="_blank" rel="noopener">Visit Website</a></p>
</td>
</tr>
</tbody>
</table>';

    $mail2 = new PHPMailer();
    $mail2->isSMTP();                                            // Send using SMTP
    $mail2->Host       = 'az1-ss30.a2hosting.com';                    // Set the SMTP server to send through
    $mail2->SMTPAuth   = true;                                   // Enable SMTP authentication
    $mail2->Username   = 'no-reply@mypedispa.com';                     // SMTP username
    $mail2->Password   = '{IzezL%*m)!N';                               // SMTP password
    $mail2->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
    $mail2->Port = "587";                                    // TCP port to connect to, use 465 for `PHPMailer::ENCRYPTION_SMTPS` above
    //Recipients

  $mail2->setFrom('no-reply@mypedispa.com', 'no-reply@mypedispa.com');  //from
$mail2->addAddress($salonemail, 'My Pedi Spa');     // to
    // Content
    $mail2->isHTML(true);                                  // Set email format to HTML
    $mail2->Subject = $subject2;
    $mail2->Body    = $msg2;
   

  $mail2->send();


$ret=mysqli_query($con,"select AptNumber from tblappointment where Email='$email' and  PhoneNumber='$phone'");
$result=mysqli_fetch_array($ret);
$_SESSION['aptno']=$result['AptNumber'];
 echo "<script>window.location.href='thank-you.php'</script>";  



  }
  else
    {
     echo '<script>swal("Something Went Wrong", "Please check and try again.", "error");</script>';
    }
  
}
?>

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Online Appointment -  My Pedi Spa</title>

    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://www.google.com/recaptcha/api.js"></script>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" >
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/fonts/fonts.css">
    <link rel="stylesheet" href="assets/css/Article-Clean.css">
    <link rel="stylesheet" href="assets/css/dh-card-image-left-dark.css">
    <link rel="stylesheet" href="assets/css/Filterable-Gallery-with-Lightbox.css">
    <link rel="stylesheet" href="assets/css/Footer-with-social-media-icons.css">
    <link rel="stylesheet" href="assets/css/Glass-Panel-With-Images.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.css">
    <link rel="stylesheet" href="assets/css/Responsive-footer-1.css">
    <link rel="stylesheet" href="assets/css/Responsive-footer.css">
    <link rel="stylesheet" href="assets/css/smoothproducts.css">
    <link rel="stylesheet" href="assets/css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <style>
         .btnicon
{
  position: fixed;
  text-align: right;
  top: 25%;
  right: 1%;
}         
.btnicon2
{
  position: fixed;
  text-align: right;
  bottom: 5%;
  right: 3%;
  padding: 1%;
}
.btnicon2 img
{

  border-radius: 50%;
  object-fit: cover;
  border:1px solid #8B0000;
padding:5px;

}
 legend {
   color: #000;
   font-size: 20px;
   margin-bottom: 10px;
}
 #hide{
  display: none;
 }
body
{
  font-family: 'Poppins';
}
    </style>
</head>

<body>
<?php include_once('includes/nav.php');?>
 
<!--Start of Modal-->
 <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog " role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Personal Information</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
    
    
                The date and time you selected is open for appointment. Please input your details below to proceed with your booking.
                              <form action="#" method="post" class="appointment-form">
                      <div class="row">
                           <input type="hidden" class="form-control" id="time"  name="time">
                           <input type="hidden" class="form-control" id="serv"  name="serv">
                            <input type="hidden" class="form-control" id="date"  name="date">
                              <input type="hidden" class="form-control" id="emp"  name="emp">
                          <div class="col-sm-6">
                            <br>

                            <div class="form-group">
                                  <input type="text" class="form-control" id="name" placeholder="Name" name="name" required="true">
                                </div>
                          </div>
                          <div class="col-sm-6"><br>
                      <div class="form-group" >
                        <input type="text" class="form-control" id="phone" name="phone" placeholder="Phone" required="true" data-mask="000-000-0000">
                      </div>
                    </div>
                    </div>
                     <div class="row">
                          <div class="col-sm-12">
                            <div class="form-group">
                                  <input type="email" class="form-control" id="appointment_email" placeholder="Email" name="email" required="true">
                                </div>
                          </div></div>
                           <div class="row">
                           <div class="col-sm-12">
                            <div class="form-group"><textarea class="form-control" id="notes" name="notes" placeholder="Notes (Optional)" ></textarea><small class="form-text text-danger help-block lead"></small></div>
                          </div></div>
                        
                       
       
      </div>
      <div class="modal-footer">

        <input type="submit" name="submit" value="Close" class="btn btn-light text-light"  data-dismiss="modal" style="background-color: grey; border-color:grey;">
      <input type="submit" name="submit" value="Book an Appointment" class="btn btn-danger"  style="background-color: #8B0000; border-color:#8B0000;">
      </div>
       </form>
    </div>
  </div>
</div>
<!-- End of Modal-->
    <main class="page contact-us-page">
        <section class="clean-block light">
            <div class="container">
                <div class="block-heading">
                    <h2 style="font-weight: 300;color: #8B0000;padding-top: 5%;">Booking Appointment</h2>
                </div>
        
                    <br><br>
                    <div class="row">
                        <div class="col-md-1"></div>
                        <div class="col-md-10">

                  <!--form-->

                         <form>
                        <div class="row" >

                            <div class="col-sm-4">
                            <div class="form-group">
                               
                           
                              <select name="services" id="services" required="true" class="form-control select-search selectpicker"  onchange="infoServ()"> 
                                <option value="">Select Service</option>
                                <?php $query=mysqli_query($con,"select * from tblservices order by ServiceCategory DESC");
                                $prev_cat = null;
              while($row=mysqli_fetch_array($query))
              {

                if ($prev_cat <> $row['ServiceCategory']) {
                         echo "<optgroup label=".$row['ServiceCategory'].">";
                         $prev_cat = $row['ServiceCategory'];
                     }
              ?>
                               <option value="<?php echo $row['ServiceName'];?>"><?php echo $row['ServiceName'].' ($'.$row['Cost'].')';?></option>
                               <?php }  ?>
                              </select>
                           
                                </div>
                          </div>


                          <div class="col-sm-4">
                            <div class="form-group">
                             <input type="text" class="form-control appointment_date" placeholder="Date" name="adate" id='adate' required="true" onchange="enableInput()" data-date-start-date="0d">
                    <!--<div  name="adate2" id='adate2'></div>-->
                            </div>    
                          </div>

                                    <div class="col-sm-4">
                                  <div class="form-group">
                                
                              
                              <select onchange="myFunction(this.value,document.getElementById('adate').value,document.getElementById('services').value)" name="employee" id="employee" required="true" class="form-control employee" disabled>
                                <option value="">Select Technician</option>
                                <?php $query1=mysqli_query($con,"select * from tblemployee");
              while($row=mysqli_fetch_array($query1))
              {
              ?>
                               <option value="<?php echo $row['Name'];?>"><?php echo $row['Name'];?></option>
                               <?php } ?> 
                              </select>
                            </div>
                                
                </div>



                          </div>

                              <div class="row " style="padding-left: 3%;padding-top: 1%;">
                              
                                 <div class="col-sm-5">
                                  <h5><span  id="aptdeets" style="display:none;">Appointment Details</span></h5>
                           
                                  <div id="infoserv" name="infoserv"></div>
                                  <div id="details" name="details"></div>
                                   <div id="dateselected" name="dateselected"></div>
                                  </div>
                                  <div class="col-sm-7">
                                  </div>
                           </div>

                          <div class="row " style="padding:3%;">
                            
                                 <div class="col-sm-12">
                                   
                                    <div id="atime" name="atime"></div>
                                 
                                </div>
                           </div>
 
                      </form>
                      <!--end of form -->
                  </div> 
                        <div class="col-md-1"></div>
                    </div>
                
            </div>
        </section>
        <!--     <div  class="btnicon">
        <?php// include_once('includes/sideicon.php');?>
      </div>-->
        <div  class="btnicon2">
        <?php include_once('includes/bottomicon.php');?>
      </div>
    </main>

           
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.js"></script>
    <script src="assets/js/smoothproducts.min.js"></script>
    <script src="assets/js/Filterable-Gallery-with-Lightbox.js"></script>
    <script src="assets/js/theme.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
         <script src="assets/js/bootstrap-datepicker.js"></script>

         <script>
        function myFunction(empid,adate,serv) {

  var xhttp = new XMLHttpRequest();
    var url = "get-time.php";
    var data = new FormData();
     data.append('empid',empid);
          data.append('adate',adate);
           data.append('serv',serv);
    xhttp.open('POST',url,true);
    xhttp.send(data);
    xhttp.onreadystatechange = function() { 
        if(xhttp.readyState == 4 && xhttp.status == 200) {  
            document.getElementById("atime").innerHTML = xhttp.responseText;
        }       
    }   
        document.getElementById("aptdeets").style.display="block";
  document.getElementById("details").innerHTML = '&emsp;  with '+document.getElementById("employee").value+'</strong><br>';

 
}

    function enableInput() {
       document.getElementById("aptdeets").style.display="block";
        document.getElementById("employee").selectedIndex = 0;
        document.getElementById("atime").innerHTML = "";
        document.getElementById("details").innerHTML = "<br>";
        document.getElementById("employee").disabled = false;
        
        var adate = document.getElementById('adate').value;
       
        document.getElementById("dateselected").innerHTML = '<i class="fa fa-calendar-o" aria-hidden="true"></i>  <strong> '+adate+'</strong>';
    
}

function infoServ()
{
       document.getElementById("aptdeets").style.display="block";
  document.getElementById("infoserv").innerHTML = '&emsp;  <strong> '+document.getElementById('services').options[document.getElementById('services').selectedIndex].text+'</strong>';
 
}
 
  $('#adate').datepicker({
     
      'format': 'm/d/yyyy',
      'autoclose': true,
      'daysOfWeekDisabled': [0],
    });



$('#exampleModal').on('show.bs.modal', function (event) {
  var button = $(event.relatedTarget) // Button that triggered the modal
  var time = button.data('time') 
  var serv = button.data('serv')
  var date = button.data('date')
    var emp = button.data('emp')// Extract info from data-* attributes
  var modal = $(this)
  modal.find('.modal-body #time').val(time)
  modal.find('.modal-body #serv').val(serv)
    modal.find('.modal-body #date').val(date)
    modal.find('.modal-body #emp').val(emp)
});

document.getElementsByClassName("custom-btn").style.width = "100px";

</script>
</body>

</html>